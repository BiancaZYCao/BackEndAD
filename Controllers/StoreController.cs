using System.Collections.Generic;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using BackEndAD.TempService;
using BackEndAD.Models;
using BackEndAD.ServiceInterface;
using System;
using System.Linq;

//REMINDER: All existing comments generated by BiancaZYCao
//This is an simple example about how to code Web API controller return data result for ReactJS
//
namespace BackEndAD.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class StoreController : ControllerBase
    {

        private IStoreClerkService _clkService;
        private IEmailService _emailService;
        private IStoreManagerService _mgrService;
        private IStoreSupervisorService _supervisorService;
        public StoreController(IEmailService emailService,IStoreClerkService clkService, IStoreManagerService mgrService, IStoreSupervisorService supervisorService)
        {
            _clkService = clkService;
            _mgrService = mgrService;
            _supervisorService = supervisorService;
            _emailService = emailService;
        }

        #region Stationery List (Inventory)
        [HttpGet("Stationeries")]
        public async Task<ActionResult<List<Stationery>>> GetAllStationeries()
        {
            var result = await _clkService.findAllStationeriesAsync();
            // if find data then return result else will return a String says Department not found
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                return NotFound("Stationeries not found");
        }

        //Post Request for stationery by id
        [HttpPost("Stationery/post")]
        public Task<ActionResult<Stationery>> PostStationery([FromBody] Stationery stationery)
        {
            Console.WriteLine("stationaryPost");
            _clkService.saveStationery(stationery);
            return null;
        }
        [HttpDelete("Stationery/delete/{id}")]
        public Task<ActionResult<Stationery>> DeleteStationery(int id)
        {
            _clkService.deleteStationery(id);
            return null;
        }

        [HttpGet("Stationeries/{id}")]
        public async Task<ActionResult<Stationery>> GetStationeryByIdAsync(int id)
        {
            var result = await _clkService.findStationeryByIdAsync(id);
            // if find data then return result else will return a String says Department not found
            if (result != null)
                return Ok(result);
            else
                return NotFound("Stationery not found");
        }
        #endregion

        #region Get Suppliers + CRUD
        [HttpGet("Suppliers")]
        public async Task<ActionResult<List<Supplier>>> GetAllSuppliers()
        {
            var result = await _clkService.findAllSuppliersAsync();
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Suppliers not found");
        }

        [HttpPost("saveSupplier")]
        public async Task<ActionResult<Supplier>> saveSupplier([FromBody] Supplier s)
        {
            Supplier sup = new Supplier()
            {
                supplierCode = s.supplierCode,
                name = s.name,
                contactPerson = s.contactPerson,
                email = s.email,
                phoneNum = s.phoneNum,
                gstRegisNo = s.gstRegisNo,
                fax = s.fax,
                address = s.address,
                priority = s.priority,
            };
            _clkService.saveSupplier(sup);

            return CreatedAtAction(nameof(GetAllSuppliers), new { }, sup);
        }

        [HttpPost("deleteSupplier")]
        public async Task<ActionResult<Supplier>> DeleteSupplier([FromBody] Supplier s)
        {
            _clkService.deleteSupplier(s.Id);
            return CreatedAtAction(nameof(GetAllSuppliers), new { }, s);
        }

        [HttpPost("updateSupplier")]
        public async Task<ActionResult<Supplier>> UpdateSupplier([FromBody] Supplier sup)
        {

            _clkService.updateSupplier(sup);
            return CreatedAtAction(nameof(GetAllSuppliers), new { }, sup);

        }
        #endregion

        #region inventory management tasks: adjustment + voucher
        //Clerk
        [HttpGet("getAllRequesterRow")]
        public async Task<ActionResult<List<StockAdjustSumById>>> GetAllRequesterRow()
        {

            var result = await _clkService.GetAllRequesterRow();
            if (result != null)
            {
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                Console.WriteLine(result[0].representativeName);
                return Ok(result);
            }
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Error");
        }

        
        [HttpPost("getDisburseItemDetail")]
        public async Task<ActionResult<List<DisburseItemDetails>>> GetDisburseItemDetail([FromBody] RequesterRow row)
        {
            var result = await _clkService.getDisburseItemDetail(row);
            if (result != null)
            {
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                String str = await _emailService.SendMail("theingi@gmail.com", "Email Testing", "This is to test email service...");
                Console.WriteLine(str);
                return Ok(result);
            }  
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Error");
        }

        //Supervisor
        [HttpGet("supervisorAdjustment")]
        public async Task<ActionResult<List<StockAdjustSumById>>> GetAllSupervisorAdustmentInfo()
        {

            var result = await _supervisorService.StockAdjustDetailInfo();
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Error");
        }

        //StoreManager stockadjustment voucher
        [HttpGet("adjustmentList")]
        public async Task<ActionResult<List<StockAdjustSumById>>> GetAllAdustmentInfo()
        {
            
            var result = await _mgrService.StockAdjustDetailInfo();
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Empty");
        }

        
        [HttpPost("getAllAdjustDetailLine")]
        public async Task<ActionResult<List<AdjustmentVocherInfo>>> getAllAdjustDetailLine([FromBody] StockAdjustSumById item)
        {
            var result = await _mgrService.getAllAdjustDetailLineByAdjustId(item);
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Error");
        }

        
        [HttpPost("getAllSupervisorAdjustDetailLine")]
        public async Task<ActionResult<List<AdjustmentVocherInfo>>> getAllSupervisorAdjustDetailLine([FromBody] StockAdjustSumById item)
        {
            var result = await _supervisorService.getAllAdjustDetailLineByAdjustId(item);
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Error");
        }

        
        [HttpPost("supervisorRejectRequest")]
        public async Task<ActionResult<List<StockAdjustSumById>>> RejectRequest([FromBody] StockAdjustSumById voc)
        {

            var result = await _supervisorService.rejectRequest(voc); 
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Empty");
        }

        [HttpPost("issueVoucher")]
        public async Task<ActionResult<List<AdjustmentVocherInfo>>> CreateVoucher([FromBody] StockAdjustSumById voc)
        {
            var result = await _mgrService.issueVoucher(voc);
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Error");

        }

        
        [HttpPost("supervisorissueVoucher")]
        public async Task<ActionResult<List<AdjustmentVocherInfo>>> SupervisorissueVoucher([FromBody] StockAdjustSumById voc)
        {
            var result = await _supervisorService.issueVoucher(voc);
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Error");

        }

        [HttpPost("getVoucher")]
        public async Task<ActionResult<AdjustmentVocherInfo>> getVoucher([FromBody] AdjustmentVocherInfo voc)
        {
            var result = await _mgrService.getEachVoucherDetail(voc);
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Error");
        }

        [HttpGet("retrieval")]
        public async Task<ActionResult<IList<RequisitionDetail>>> GetAllPendingRequisitions()
        {
            var allRD = await _clkService.findAllRequsitionDetailsAsync();

            var nonDeliveredRD = allRD.Where(x => x.status != "Delivered");
            
            var nonDeclinedRD = nonDeliveredRD.Where(x => x.status != "Declined");
            var result = nonDeclinedRD.Where(x => x.reqQty != x.rcvQty);


            if (result != null)
            {
                //convert to json file
                Console.WriteLine("android called for pending retrievals");
                return Ok(result);
            }
            else
                //in case there is nothing to process
                return NotFound("No pending requistions");
        }

       

        [HttpPost("getRetrieval")]
        public async Task<ActionResult<Requisition>> processRetrieval(
              [FromBody] fakeRequisition requistitions)
        {
            var result = await _clkService.findAllRequsitionDetailsAsync();
            Console.WriteLine("post");
            Console.WriteLine(requistitions);           
            return Ok(requistitions);
        }

        [HttpPost("processRetrieval")]
        public async Task<ActionResult<Requisition>> processRetrieval(
              [FromBody] List<fakeRequisitionDetails> fakeRequisitions)
        {
            #region data fetching for processing
            Console.WriteLine("post");
            var allRD = await _clkService.findAllRequsitionDetailsAsync();
            var nonDeliveredRD = allRD.Where(x => x.status != "Delivered");
            var requisitiondetails = nonDeliveredRD.Where(x => x.status != "Declined");
            var requisitions = await _clkService.findAllRequsitionAsync();
            var stationeries = await _clkService.findAllStationeriesAsync();
            var departments = await _clkService.findAllDepartmentAsync();
            var collectionpoints = await _clkService.findAllCollectionPointAsync();
            Console.WriteLine("fetching done and starting processing");
            #endregion

            #region create new Stock Adjustment
            StockAdjustment newSA = new StockAdjustment();
            newSA.date = DateTime.Now;
            newSA.EmployeeId = 15;
            newSA.type = "stock retrieval";
            _clkService.saveStockAdjustment(newSA);
            Console.WriteLine("created stock adjustment");
            #endregion

            #region creating necessary Disbursement List
            HashSet<Department> deptlist = new HashSet<Department>();
            foreach (fakeRequisitionDetails i in fakeRequisitions)
            {
                foreach (RequisitionDetail rd in requisitiondetails)
                {
                    if ((i.reqQty != 0) && (i.id == rd.Id))
                    {
                        var rul = await _clkService.findEmployeeByIdAsync(requisitions.Where(y => y.Id == rd.RequisitionId).FirstOrDefault().EmployeeId);
                        deptlist.Add(departments.Where(x=>x.Id== rul.departmentId).FirstOrDefault());
                    }
                }
            }
            List<DisbursementList> disbursementList = new List<DisbursementList>();
            foreach (Department d in deptlist)
            {
                DisbursementList newDL = new DisbursementList();
                newDL.DepartmentId = d.Id;
                newDL.date = DateTime.Now;
                newDL.deliveryPoint = collectionpoints.Where(x=>x.Id == d.Id).FirstOrDefault().collectionPoint; 
                //d.Collection.collectionPoint;
                disbursementList.Add(newDL);
                _clkService.saveDisbursementList(newDL);

            }
            #endregion

            foreach (DisbursementList dl in disbursementList)
            {
                foreach (fakeRequisitionDetails i in fakeRequisitions)
                {
                    foreach (RequisitionDetail rd in requisitiondetails)
                    {
                        if ((i.reqQty != 0) && (i.id == rd.Id))
                        {
                            var currEmp = await _clkService.findEmployeeByIdAsync(requisitions.Where(y => y.Id == rd.RequisitionId).FirstOrDefault().EmployeeId);

                            if (currEmp.departmentId == dl.DepartmentId)
                            {
                                //process incoming i which are not 0 in reqQty
                                //fetch the i.Id to match the RD in db
                                //1.based on the RD found, add the i.rcvQty to the RD.rcvQty
                                //1.1save the RD back in database
                                //2.create a new StockAdjustment
                                //2.1create a list of stockadjustments based on i.id and i.rcvqty
                                //3.update the quantity of stationery

                                #region saving stockadjustments                               
                                StockAdjustmentDetail SAD = new StockAdjustmentDetail();
                                SAD.stockAdjustmentId = newSA.Id;
                                SAD.StationeryId = rd.StationeryId;
                                SAD.discpQty = -(i.reqQty);
                                SAD.comment = "sent to " + departments.Where(x => x.Id == currEmp.departmentId).FirstOrDefault().deptName;
                                SAD.Status = null;
                                _clkService.saveStockAdjustmentDetail(SAD);
                                #endregion

                                #region updating stationeries item
                                foreach (Stationery s in stationeries)
                                {
                                    if (s.Id == rd.StationeryId)
                                    {
                                        s.inventoryQty -= i.reqQty;
                                        _clkService.updateStationery(s);
                                    }
                                }
                                #endregion
                                
                                #region updating requisition detail
                                
                                rd.rcvQty += i.reqQty;
                                Console.WriteLine($"{rd.Id},{rd.reqQty},{rd.rcvQty},{rd.StationeryId}, for the incoming {i.reqQty}");
                                _clkService.udpateRequisitionDetail(rd);
                                #endregion

                                #region creating disbursements
                                DisbursementDetail currDB = new DisbursementDetail();
                                currDB.DisbursementListId = dl.id;
                                currDB.qty = i.reqQty;
                                currDB.RequisitionDetailId = rd.Id;
                                _clkService.saveDisbursementDetail(currDB);
                                #endregion
                                
                              

                                Console.WriteLine("id:" + i.id + ", reqID:" + rd.RequisitionId + ", qty:" + i.reqQty);
                            }
                        }

                    }

                }
            }
            Console.WriteLine("done");
            return Ok(fakeRequisitions);
        }



        //end

        #region Test post method 18Aug
        [HttpPost("stkAd/{id}")]
        public async Task<ActionResult<StockAdjustment>> PostTestStkAd(
               [FromBody] List<StockAdjustmentDetail> stockAdjustmentDetails, int id)
        {
            StockAdjustment stkAdj = new StockAdjustment()
            {
                date = DateTime.Now,
                type = "inventory check",
                EmployeeId = id
            };

            var result = await _clkService.generateStkAdjustmentAsync(stkAdj, stockAdjustmentDetails); //SaveChangesAsync();
            if (result != null)
                return CreatedAtAction(
                    nameof(GetStkAdjId), new { id = result.Id }, result);
            else
                return NotFound("Sry failed.");
        }

        [HttpGet("stkAd/get/{id}")]
        public async Task<ActionResult<StockAdjustment>> GetStkAdjId(int id)
        {
            var result = await _clkService.findStockAdjustmentByIdAsync(id);
            if (result != null)
                //Docs says that Ok(...) will AUTO TRANSFER result into JSON Type
                return Ok(result);
            else
                //this help to return a NOTfOUND result, u can customerize the string.
                return NotFound("Suppliers not found");
        }
        [HttpPut("stkAd/put")]
        public Task<ActionResult<StockAdjustment>> PutStkAd([FromBody] List<StockAdjustmentDetail> stockAdjustmentDetails)
        {
            _clkService.updateStockAdjustment(stockAdjustmentDetails);
            return null;
        }
        #endregion
        #endregion

        #region place order 
        /*[HttpGet("placeOrder")]
        public async Task<ActionResult<ReOrderRecViewModel>> GetReOrderRec()
        {
            //iterate through stationery
            var stationeries = await _clkService.findAllStationeriesAsync();
            IList<ReOrderRecViewModel> result = new List<ReOrderRecViewModel>();
            int id = 0;

            foreach (Stationery s in stationeries)
            {
                //find all suppliers that supply stationery 
                ICollection<Supplier> suppliers = await _clkService.findSupplierByStationeryId(1);
                //s.Id);

                //create a ReOrderRecViewModel for each stationery
                ReOrderRecViewModel reorder = new ReOrderRecViewModel()
                {
                    id = id,
                    stationery = s,
                    suppliers = suppliers
                };

                result.Add(reorder);
                id++;
            }

            if (result != null)
            {
                return Ok(result);
            }

            else
                return NotFound("No reorder items at this time.");
        }*/

        //api to get current clerk Id [HttpGet("/clerk")]

        [HttpPost("generatePO")]
        public int[] PostPurchaseOrder(
              [FromBody] List<PurchaseOrder> purchaseOrders)
        {
            int[] result = new int[ purchaseOrders.Count];
           
            for (int i = 0; i < purchaseOrders.Count; i++)
            {
                PurchaseOrder po = purchaseOrders[i];
                po.dateOfOrder = DateTime.Now;
                _clkService.savePurchaseOrder(po);
                result[i]= po.id;
            }
            
            return result;
        }

        [HttpGet("getPO/{id}")]
        public async Task<ActionResult<List<PurchaseOrderDetail>>> GetPurchaseOrder(int id)
        {
            var result = await _clkService.findPOById(id);

            if (result != null)
                return Ok(result);
            else return null;
            
        }

        

        [HttpGet("getEmployee/{id}")]
        public async Task<ActionResult<Employee>> GetEmployee(int id)
        {
            var result = await _clkService.findEmployeeByIdAsync(id);

            if (result != null)
            {
                return Ok(result);
            }
            else 
                return null;

        }

        [HttpGet("getSupplier/{id}")]
        public async Task<ActionResult<Supplier>> GetSupplier(int id)
        {
            var result = await _clkService.findSupplierByIdAsync(id);

            if (result != null)
            {
                return Ok(result);
            }
            else
                return null;


        }

        [HttpPost("updatePO")]
        public PurchaseOrder UpdatePO([FromBody] PurchaseOrder po)
        {

            _clkService.updatePO(po);
            return po;

        }

        [HttpGet("ItemsNeedOrder")]
        public async Task<ActionResult<List<Stationery>>> GetItemsNeedOrder()
        {
            //iterate through stationery
            IList<Stationery> stationeries = await _clkService.findAllStationeriesAsync();
            List<Stationery> itemsNeedOrder =
                stationeries.Where(x => x.inventoryQty < x.reOrderLevel).ToList();
            return itemsNeedOrder;
            
        }
        [HttpGet("getSupplierItems/{id}")]
        public IList<SupplierItem> GetSupplierItemsListByStationeryId(int id)
        {
            IList<SupplierItem> result = _clkService.findSuppliersByStationeryId(id);
            foreach (SupplierItem s in result)
            {
                Console.WriteLine(s.StationeryId);
                    }
            if (result != null)
            {
                return result;
            }
            else
                return null;
            

        }

        [HttpGet("getPOD/{id}")]
        public IList<PurchaseOrderDetail> GetPurchaseOrderDetail(int id)
        {
            IList<PurchaseOrderDetail> result = _clkService.findPODById(id);

            if (result != null)
                return result;
            else return null;

        }

         [HttpGet("getAllPOs")]
        public async Task<ActionResult<IList<PurchaseOrder>>> GetAllPos()
        {
            IList<PurchaseOrder> result = await _clkService.findAllPOAsync();
           
            if(result!=null)
                return Ok(result);
            else return null;


        }



        #endregion


    }
}